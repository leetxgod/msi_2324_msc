\begin{algorithm}[H]
\caption{\textsc{nfaPosCount}($R$): Construct Special Position Automaton}
\label{alg:nfaPosCount}
\begin{small}
\begin{algorithmic}[1]
\Require Regular expression $R$
\Ensure NFA $A$

\State $A \gets$ new empty NFA
\State $i \gets A.\text{addInitialState}()$
\State $A.\text{addTransitionStar}(i, i)$ \Comment{Accept any symbol from $\Sigma$}

\State $f_R \gets R.\text{marked}()$
\State $\text{stack} \gets$ empty stack
\State $\text{addedStates} \gets$ empty map

\ForAll{$p \in First(f_R)$}
    \State $q \gets A.\text{addState}(p)$
    \State $\text{addedStates}[p] \gets q$
    \State $\text{stack}.\text{push}((p, q))$
    \State $A.\text{addTransition}(i, p, q)$
\EndFor

% \State $\text{FollowSets} \gets Follow(f_R)$

\While{stack is not empty}
    \State $(s, s_{\text{idx}}) \gets \text{stack}.\text{pop}()$
    \ForAll{$t \in Follow(f_R, s)$}
        \If{$t \in \text{addedStates}$}
            \State $q \gets \text{addedStates}[t]$
        \Else
            \State $q \gets A.\text{addState}(t)$
            \State $\text{addedStates}[t] \gets q$
            \State $\text{stack}.\text{push}((t, q))$
        \EndIf
        \State $A.\text{addTransition}(s_{\text{idx}}, t, q)$
    \EndFor
\EndWhile

\State $e \gets A.\text{addState}()$
\State $A.\text{addTransitionStar}(e, e)$

\ForAll{$p \in f_R.\text{Last}()$}
    \If{$p \in \text{addedStates}$}
        \State $A.\text{addFinal}(\text{addedStates}[p])$
        \State $A.\text{addTransitionStar}(\text{addedStates}[p], e)$
    \EndIf
\EndFor

\end{algorithmic}
\end{small}
\end{algorithm}